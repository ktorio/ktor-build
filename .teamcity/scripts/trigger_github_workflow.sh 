#!/bin/bash

getBranchName() {
    local BRANCH_NAME="$1"
    local GITHUB_TOKEN="$2"
    local REPO="$3"
    local DEFAULT_BRANCH=""

    echo "Original branch name: $BRANCH_NAME"

    echo "Retrieving default branch for repository..."
    REPO_DATA="$(curl -s \
          -H "Authorization: token $GITHUB_TOKEN" \
          -H "Accept: application/vnd.github.v3+json" \
          https://api.github.com/repos/"$REPO")"

    if command -v jq &> /dev/null; then
        DEFAULT_BRANCH=$(echo "$REPO_DATA" | jq -r '.default_branch // "main"')
    else
        DEFAULT_BRANCH=$(echo "$REPO_DATA" | grep -o '"default_branch":"[^"]*"' | cut -d'"' -f4)
        if [ -z "$DEFAULT_BRANCH" ]; then
            DEFAULT_BRANCH="master"
        fi
    fi
    echo "Repository default branch: $DEFAULT_BRANCH"

    if [[ "$BRANCH_NAME" =~ pull/([0-9]+) ]]; then
        PR_NUMBER=${BASH_REMATCH[1]}
        echo "Detected pull request #$PR_NUMBER"

        echo "Getting PR source branch..."
        PR_DATA="$(curl -s \
          -H "Authorization: token $GITHUB_TOKEN" \
          -H "Accept: application/vnd.github.v3+json" \
          https://api.github.com/repos/"$REPO"/pulls/"$PR_NUMBER")"

        if command -v jq &> /dev/null; then
            PR_HEAD=$(echo "$PR_DATA" | jq -r '.head.ref // empty')
            if [ -n "$PR_HEAD" ]; then
                echo "Using PR source branch (jq): $PR_HEAD"
                TARGET_BRANCH="$PR_HEAD"
            else
                echo "WARNING: Could not determine PR source branch, falling back to default branch"
                TARGET_BRANCH="$DEFAULT_BRANCH"
            fi
        else
            PR_HEAD=$(echo "$PR_DATA" | grep -o '"head":{[^}]*}' | grep -o '"ref":"[^"]*"' | cut -d'"' -f4)

            if [ -n "$PR_HEAD" ]; then
                echo "Using PR source branch: $PR_HEAD"
                TARGET_BRANCH="$PR_HEAD"
            else
                echo "WARNING: Could not determine PR source branch, falling back to default branch"
                TARGET_BRANCH="$DEFAULT_BRANCH"
            fi
        fi
    else
        if [ -n "$BRANCH_NAME" ] && [ "$BRANCH_NAME" != "<default>" ]; then
            BRANCH_NAME="${BRANCH_NAME#refs/heads/}"
            TARGET_BRANCH="$BRANCH_NAME"
        else
            TARGET_BRANCH="$DEFAULT_BRANCH"
        fi

        echo "Using branch: $TARGET_BRANCH"
    fi

    ENCODED_BRANCH=$(printf "%s" "$TARGET_BRANCH" | jq -s -R -r @uri)

    BRANCH_CHECK=$(curl -s -o /dev/null -w "%{http_code}" \
      -H "Authorization: token $GITHUB_TOKEN" \
      -H "Accept: application/vnd.github.v3+json" \
      "https://api.github.com/repos/$REPO/branches/$ENCODED_BRANCH")

    if [ "$BRANCH_CHECK" != "200" ]; then
        echo "Branch $TARGET_BRANCH does not exist. Falling back to default branch."
        TARGET_BRANCH="$DEFAULT_BRANCH"
    fi

    echo "$TARGET_BRANCH"
}

triggerWorkflow() {
    local REPO="$1"
    local WORKFLOW_FILE="$2"
    local TARGET_BRANCH="$3"
    local GITHUB_TOKEN="$4"

    echo "Triggering workflow on branch: $TARGET_BRANCH"

    REGISTRY_USERNAME="${REGISTRY_USERNAME:-}"
    REGISTRY_PASSWORD="${REGISTRY_PASSWORD:-}"

    PAYLOAD=$(cat <<EOF
{
  "ref": "$TARGET_BRANCH",
  "inputs": {
    "registry_username": "$REGISTRY_USERNAME",
    "registry_password": "$REGISTRY_PASSWORD"
  }
}
EOF
)

    HTTP_STATUS="$(curl -s -o response.txt -w "%{http_code}" -X POST \
    -H "Authorization: token $GITHUB_TOKEN" \
    -H "Accept: application/vnd.github.v3+json" \
    -H "Content-Type: application/json" \
    https://api.github.com/repos/"$REPO"/actions/workflows/"$WORKFLOW_FILE"/dispatches \
    -d "$PAYLOAD")"

    if [ "$HTTP_STATUS" != "204" ]; then
        echo "Failed to trigger workflow. HTTP status: $HTTP_STATUS"
        echo "Error details (without credentials):"
        cmd < response.txt | sed 's/"registry_username":"[^"]*"/"registry_username":"***"/g' | sed 's/"registry_password":"[^"]*"/"registry_password":"***"/g'
        rm -f response.txt
        return 1
    fi

    rm -f response.txt
    echo "Successfully triggered GitHub Actions workflow on branch: $TARGET_BRANCH"
    return 0
}

findLatestWorkflowByName() {
    local REPO="$1"
    local TARGET_BRANCH="$2"
    local GITHUB_TOKEN="$3"
    local WORKFLOW_NAME="End-to-End Tests with Docker"
    local START_TIME
    START_TIME="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"

    echo "Looking for the latest '$WORKFLOW_NAME' workflow run that started after $START_TIME..."

    WORKFLOW_ID=""
    MAX_ATTEMPTS=30
    ATTEMPT=0
    SLEEP_SECONDS=10

    while [ -z "$WORKFLOW_ID" ] && [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
        ATTEMPT=$((ATTEMPT+1))
        echo "Checking for workflow run (attempt $ATTEMPT/$MAX_ATTEMPTS)..."

        RUNS_URL="https://api.github.com/repos/$REPO/actions/runs?branch=$TARGET_BRANCH&per_page=10"

        WORKFLOWS=$(curl -s \
          -H "Authorization: token $GITHUB_TOKEN" \
          -H "Accept: application/vnd.github.v3+json" \
          "$RUNS_URL")

        if command -v jq &> /dev/null; then
            WORKFLOW_ID=$(echo "$WORKFLOWS" | jq -r --arg time "$START_TIME" --arg name "$WORKFLOW_NAME" \
                '.workflow_runs[] | select(.created_at >= $time) | select(.name == $name) | .id' | head -n 1)
        else
            WORKFLOW_JSON=$(echo "$WORKFLOWS" | grep -o '{[^}]*"name":"'"$WORKFLOW_NAME"'"[^}]*}' | head -n 1)
            if [ -n "$WORKFLOW_JSON" ]; then
                WORKFLOW_CREATED=$(echo "$WORKFLOW_JSON" | grep -o '"created_at":"[^"]*"' | cut -d'"' -f4)

                if [[ "$WORKFLOW_CREATED" > "$START_TIME" ]]; then
                    WORKFLOW_ID=$(echo "$WORKFLOW_JSON" | grep -o '"id":[0-9]*' | cut -d':' -f2)
                fi
            fi
        fi

        if [ -n "$WORKFLOW_ID" ]; then
            echo "Found workflow run with ID: $WORKFLOW_ID"
            break
        fi

        echo "Waiting $SLEEP_SECONDS seconds before checking again..."
        sleep $SLEEP_SECONDS
    done

    if [ -z "$WORKFLOW_ID" ]; then
        echo "Could not find a '$WORKFLOW_NAME' workflow run after $MAX_ATTEMPTS attempts."
        return 1
    fi

    echo "$WORKFLOW_ID"
}

monitorWorkflow() {
    local REPO="$1"
    local WORKFLOW_ID="$2"
    local GITHUB_TOKEN="$3"

    echo "Monitoring workflow run status (ID: $WORKFLOW_ID)..."

    MAX_MONITOR_ATTEMPTS=60
    MONITOR_ATTEMPT=0
    MONITOR_SLEEP_SECONDS=30

    while [ $MONITOR_ATTEMPT -lt $MAX_MONITOR_ATTEMPTS ]; do
        MONITOR_ATTEMPT=$((MONITOR_ATTEMPT+1))

        WORKFLOW_DATA=$(curl -s \
          -H "Authorization: token $GITHUB_TOKEN" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/$REPO/actions/runs/$WORKFLOW_ID")

        if command -v jq &> /dev/null; then
            WORKFLOW_STATUS=$(echo "$WORKFLOW_DATA" | jq -r '.status')
            WORKFLOW_CONCLUSION=$(echo "$WORKFLOW_DATA" | jq -r '.conclusion')
            WORKFLOW_URL=$(echo "$WORKFLOW_DATA" | jq -r '.html_url')
        else
            WORKFLOW_STATUS=$(echo "$WORKFLOW_DATA" | grep -o '"status":"[^"]*"' | head -n 1 | cut -d'"' -f4)
            WORKFLOW_CONCLUSION=$(echo "$WORKFLOW_DATA" | grep -o '"conclusion":"[^"]*"' | head -n 1 | cut -d'"' -f4 || echo "")
            WORKFLOW_URL=$(echo "$WORKFLOW_DATA" | grep -o '"html_url":"[^"]*"' | head -n 1 | cut -d'"' -f4)
        fi

        echo "Workflow status: $WORKFLOW_STATUS, conclusion: $WORKFLOW_CONCLUSION (check $MONITOR_ATTEMPT/$MAX_MONITOR_ATTEMPTS)"
        echo "Workflow URL: $WORKFLOW_URL"

        if [ "$WORKFLOW_STATUS" = "completed" ]; then
            echo "Workflow run completed with conclusion: $WORKFLOW_CONCLUSION"

            if [ "$WORKFLOW_CONCLUSION" = "success" ]; then
                echo "Workflow succeeded!"
                return 0
            else
                echo "Workflow failed with conclusion: $WORKFLOW_CONCLUSION"
                return 1
            fi
        fi

        echo "Waiting $MONITOR_SLEEP_SECONDS seconds before checking again..."
        sleep $MONITOR_SLEEP_SECONDS
    done

    echo "Timed out waiting for workflow to complete after $((MAX_MONITOR_ATTEMPTS * MONITOR_SLEEP_SECONDS)) seconds."
    return 1
}

triggerAndMonitorWorkflow() {
    local REPO="$1"
    local WORKFLOW_FILE="$2"
    local BRANCH_NAME="$3"
    local GITHUB_TOKEN="$4"

    if [ -z "${REGISTRY_USERNAME}" ] || [ -z "${REGISTRY_PASSWORD}" ]; then
            echo "Registry credentials must be set as environment variables REGISTRY_USERNAME and REGISTRY_PASSWORD"
    fi

    TARGET_BRANCH=$(getBranchName "$BRANCH_NAME" "$GITHUB_TOKEN" "$REPO")

    if ! triggerWorkflow "$REPO" "$WORKFLOW_FILE" "$TARGET_BRANCH" "$GITHUB_TOKEN"
    then
        exit 1
    fi

    if ! WORKFLOW_ID=$(findLatestWorkflowByName "$REPO" "$TARGET_BRANCH" "$GITHUB_TOKEN")
    then
        exit 1
    fi

    if ! monitorWorkflow "$REPO" "$WORKFLOW_ID" "$GITHUB_TOKEN"
    then
        exit 1
    fi

    exit 0
}
